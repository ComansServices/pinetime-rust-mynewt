<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Draw your own PineTime Watch Face... From WebAssembly to Embedded Rust</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Draw your own PineTime Watch Face... From WebAssembly to Embedded Rust" 
    data-rh="true">
<meta property="og:description" 
    content="How we build a hand-drawn Watch Face for PineTime Smart Watch... Starting from WebAssembly to Embedded Rust" 
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/handdrawn-title.png">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Draw your own PineTime Watch Face... From WebAssembly to Embedded Rust</h1>
    <nav id="TOC"><ul>
<li><a href="#hand-drawn-watch-face">1 Hand-Drawn Watch Face</a><ul>
<li><a href="#compute-the-hour-digit">1.1 Compute the hour digit</a><ul></ul></li>
<li><a href="#fetch-the-digit-bitmap">1.2 Fetch the digit bitmap</a><ul></ul></li>
<li><a href="#set-the-image-source">1.3 Set the image source</a><ul></ul></li>
<li><a href="#declare-the-method">1.4 Declare the method</a><ul></ul></li></ul></li>
<li><a href="#webassembly-rust">2 WebAssembly Rust</a><ul></ul></li>
<li><a href="#embedded-rust">3 Embedded Rust</a><ul></ul></li>
<li><a href="#whats-next">4 What's Next</a><ul></ul></li></ul></nav><p><img src="https://lupyuen.github.io/images/handdrawn-title.png" alt="PineTime Smart Watch with Hand-Drawn Watch Face" /></p>
<p><em>Q: We're in the middle of the pandemic... Is there something fun and useful that we can learn on our own?</em></p>
<p>A: Try learning <strong>Embedded Programming</strong>!</p>
<p><em>Q: I need to buy an Arduino or a Microcontroller Board? And have it shipped sloooowly to me at exorbitant prices?</em></p>
<p>A: Nope! Today we can build and test Embedded Programs in a Web Browser... <strong>Without any Embedded Hardware</strong>! Made possible with awesome WebAssembly tools.</p>
<p><em>Q: But a Web Browser Simulator doesn't behave like Real Hardware right?</em></p>
<p>A: We have a real <a href="https://wiki.pine64.org/index.php/PineTime"><strong>PineTime Smart Watch</strong></a> that's connected to the web for everyone to test our Embedded Programs... Try it for yourself and compare!</p>
<p><em>Q: People say that Embedded Programming is hard... Needs strange languages like C</em></p>
<p>A: Not any more! Today we'll code with <strong>Rust</strong>, a friendly, modern language. (And less frustating for new coders)</p>
<p><em>Q: Great! But my computer is kinda old, slow and weak... Do I need a powerful Linux desktop?</em></p>
<p>A: Any <strong>Linux, macOS AND Windows</strong> computer works great for coding in Embedded Rust and WebAssembly... Even a Raspberry Pi!</p>
<p>If you prefer zero setup, we can build our Embedded Rust and WebAssembly programs <strong>in the Cloud</strong>! (Provided free of change by GitHub Actions and GitLab CI)</p>
<p>It feels strange... But building and testing Embedded Programs will work on a <strong>Mobile Web Browser</strong>!</p>
<p><em>Q: Fantastic! Can't wait to build my very first Blinking LED program!</em></p>
<p>A: Well it's 2020, and we have progressed waaaay beyond Blinking LEDs ;-)</p>
<p>Today we'll learn to build a <strong>Smart Watch Face</strong> in Rust. We'll be coding for a Smart Watch with <strong>Colour Touchscreen, Bluetooth Networking</strong> and <strong>Real Time Clock</strong>... Just like the expensive watches by A***e and S*****g!</p>
<p>As promised, our Watch Face will run in a Web Browser, so it will be easy to test and troubleshoot.</p>
<p>And when you're done... Please flash your Watch Face to our <strong>Remote PineTime</strong> over the web. Show the world your embedded creation... Running on a real watch!</p>
<p><em>Q: But what's the catch?</em></p>
<p>None really. Now's the perfect time to <strong>Learn and Experiment with Embedded Programming</strong>... At our own pace, with whatever materials we have.</p>
<p>Read on and join me for the learning adventure! :-)</p>
<h1 id="hand-drawn-watch-face" class="section-header"><a href="#hand-drawn-watch-face">1 Hand-Drawn Watch Face</a></h1>
<p>TODO</p>
<p>Let's make a Hand-Drawn Watch Face like the pic above. The Watch Face consists of 4 images that will be a-changin' with the times...</p>
<p>??? left top image - first digit of the hour</p>
<p>Let's zoom in to the top left image...</p>
<p><em>How shall we load the top left image with the first digit of the hour?</em></p>
<p>Let's start with the 3 hardest lines of code in our Watch Face: <a href="https://github.com/lupyuen/handdrawn-watchface/blob/master/src/lib.rs#L142-L150"><code>lib.rs</code></a></p>
<p><em>(I promise you... The rest of the code will be much simpler)</em></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="comment">//  Update the top left image with the first digit of the hour</span>

<span class="comment">//  Compute the first digit of the hour</span>
<span class="kw">let</span> <span class="ident">digit</span> <span class="op">=</span> <span class="ident">state</span>.<span class="ident">time</span>.<span class="ident">hour</span> <span class="op">/</span> <span class="number">10</span>;  

<span class="comment">//  Fetch the bitmap for the digit as a constant pointer</span>
<span class="kw">let</span> <span class="ident">bitmap</span>: <span class="kw-2">*</span><span class="kw">const</span> <span class="ident">img</span>::<span class="ident">lv_img_dsc_t</span> <span class="op">=</span>    
    <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">bitmaps</span>[<span class="ident">digit</span> <span class="kw">as</span> <span class="ident">usize</span>];

<span class="ident">img</span>::<span class="ident">set_src</span>(                <span class="comment">//  Set the source...</span>
    <span class="self">self</span>.<span class="ident">top_left_image</span>,     <span class="comment">//  Of the the top left image...</span>
    <span class="ident">bitmap</span> <span class="kw">as</span> <span class="kw-2">*</span><span class="kw">const</span> <span class="ident">c_void</span>  <span class="comment">//  To the digit bitmap</span>
) <span class="question-mark">?</span> ;                        <span class="comment">//  Quit in case of error</span></pre></div>
<h2 id="compute-the-hour-digit" class="section-header"><a href="#compute-the-hour-digit">1.1 Compute the hour digit</a></h2>
<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="comment">//  Compute the first digit of the hour</span>
<span class="kw">let</span> <span class="ident">digit</span> <span class="op">=</span> <span class="ident">state</span>.<span class="ident">time</span>.<span class="ident">hour</span> <span class="op">/</span> <span class="number">10</span>;</pre></div>
<p>We interpret <code>state.time.hour</code> like a nested fairy tale...</p>
<blockquote>
<p>Once upon a time, there was an object named <code>state</code>... That contained an object named <code>time</code>... That contained a field named <code>hour</code>... The current hour of the day (from 0 to 23)</p>
</blockquote>
<p>(We'll learn the backstory of <code>state</code> in a while)</p>
<p>rust compiler is spooky</p>
<p>mouse over</p>
<p>handdrawn-type.png</p>
<p>c vs javascript vs python</p>
<h2 id="fetch-the-digit-bitmap" class="section-header"><a href="#fetch-the-digit-bitmap">1.2 Fetch the digit bitmap</a></h2>
<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="comment">//  Fetch the bitmap for the digit as a constant pointer</span>
<span class="kw">let</span> <span class="ident">bitmap</span>: <span class="kw-2">*</span><span class="kw">const</span> <span class="ident">img</span>::<span class="ident">lv_img_dsc_t</span> <span class="op">=</span>    
    <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">bitmaps</span>[<span class="ident">digit</span> <span class="kw">as</span> <span class="ident">usize</span>];</pre></div>
<p>Hint: It's a pointer. No we're not shopping for French luxury goods.</p>
<h2 id="set-the-image-source" class="section-header"><a href="#set-the-image-source">1.3 Set the image source</a></h2>
<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">img</span>::<span class="ident">set_src</span>(                <span class="comment">//  Set the source...</span>
    <span class="self">self</span>.<span class="ident">top_left_image</span>,     <span class="comment">//  Of the the top left image...</span>
    <span class="ident">bitmap</span> <span class="kw">as</span> <span class="kw-2">*</span><span class="kw">const</span> <span class="ident">c_void</span>  <span class="comment">//  To the digit bitmap</span>
) <span class="question-mark">?</span> ;                        <span class="comment">//  Quit in case of error</span></pre></div>
<p>casting</p>
<p>c interface</p>
<p>low level</p>
<p>raw pointer</p>
<p>*bitmap = 123;</p>
<p>we cant do this even by casting the type</p>
<h2 id="declare-the-method" class="section-header"><a href="#declare-the-method">1.4 Declare the method</a></h2>
<p><code>self</code> and <code>state</code> come from the method declaration: <a href="https://github.com/lupyuen/handdrawn-watchface/blob/master/src/lib.rs#L141-L181"><code>lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Update the widgets in the Watch Face with the current time</span>
<span class="kw">fn</span> <span class="ident">update</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">state</span>: <span class="kw-2">&amp;</span><span class="ident">WatchFaceState</span>) <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
    <span class="comment">//  Update the top left image with the first digit of the hour</span>
    <span class="kw">let</span> <span class="ident">digit</span> <span class="op">=</span> <span class="ident">state</span>.<span class="ident">time</span>.<span class="ident">hour</span> <span class="op">/</span> <span class="number">10</span>;      <span class="comment">//  Compute the first digit of the hour</span>
    <span class="kw">let</span> <span class="ident">bitmap</span>: <span class="kw-2">*</span><span class="kw">const</span> <span class="ident">img</span>::<span class="ident">lv_img_dsc_t</span> <span class="op">=</span> <span class="comment">//  Fetch the bitmap for the digit...</span>
        <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">bitmaps</span>[<span class="ident">digit</span> <span class="kw">as</span> <span class="ident">usize</span>];     <span class="comment">//  As a constant pointer</span>
    <span class="ident">img</span>::<span class="ident">set_src</span>(                          <span class="comment">//  Set the source...</span>
        <span class="self">self</span>.<span class="ident">top_left_image</span>,               <span class="comment">//  Of the the top left image...</span>
        <span class="ident">bitmap</span> <span class="kw">as</span> <span class="kw-2">*</span><span class="kw">const</span> <span class="ident">c_void</span>            <span class="comment">//  To the digit bitmap</span>
    ) <span class="question-mark">?</span> ;
    ...
    <span class="comment">//  Omitted: Update the top right, bottom left and bottom right images, </span>
    ... 
    <span class="comment">//  Return OK</span>
    <span class="prelude-val">Ok</span>(())
}</pre></div>
<p>Create watch face: <a href="https://github.com/lupyuen/handdrawn-watchface/blob/master/src/lib.rs#L76-L136"><code>lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Create the widgets for the Watch Face</span>
<span class="kw">fn</span> <span class="ident">new</span>() <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span> {
    <span class="comment">//  Get the active screen</span>
    <span class="kw">let</span> <span class="ident">screen</span> <span class="op">=</span> <span class="ident">watchface</span>::<span class="ident">get_active_screen</span>();

    <span class="comment">//  Compose the image header</span>
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">header</span> <span class="op">=</span> <span class="ident">img</span>::<span class="ident">lv_img_header_t</span>::<span class="ident">default</span>();
    <span class="ident">header</span>.<span class="ident">set_cf</span>(<span class="ident">img</span>::<span class="ident">LV_IMG_CF_TRUE_COLOR</span>);  <span class="comment">//  Color Format</span>
    <span class="ident">header</span>.<span class="ident">set_w</span>(<span class="ident">IMAGE_WIDTH</span>);                 <span class="comment">//  Width</span>
    <span class="ident">header</span>.<span class="ident">set_h</span>(<span class="ident">IMAGE_HEIGHT</span>);                <span class="comment">//  Height</span>

    <span class="comment">//  Compute the image size</span>
    <span class="kw">let</span> <span class="ident">data_size</span> <span class="op">=</span> <span class="ident">IMAGE_WIDTH</span> <span class="op">*</span> <span class="ident">IMAGE_HEIGHT</span> <span class="op">*</span> <span class="ident">BYTES_PER_PIXEL</span>;</pre></div>
<p>Create widgets...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
    <span class="comment">//  Create the widgets</span>
    <span class="kw">let</span> <span class="ident">watch_face</span> <span class="op">=</span> <span class="self">Self</span> {
        <span class="comment">//  Create the top left image</span>
        <span class="ident">top_left_image</span>: {
            <span class="kw">let</span> <span class="ident">image</span> <span class="op">=</span> <span class="ident">img</span>::<span class="ident">create</span>(<span class="ident">screen</span>, <span class="ident">ptr</span>::<span class="ident">null</span>()) <span class="question-mark">?</span> ;  <span class="comment">//  `?` will terminate the function in case of error</span>
            <span class="ident">obj</span>::<span class="ident">set_pos</span>(<span class="ident">image</span>, <span class="number">40</span>, <span class="number">20</span>) <span class="question-mark">?</span> ;  <span class="comment">//  Set image position to top left</span>
            <span class="ident">image</span>                            <span class="comment">//  Return the image as top_left_image</span>
        },

        <span class="comment">//  Omitted: Create the top right image</span>
        <span class="ident">top_right_image</span>: { ... },

        <span class="comment">//  Omitted: Create the bottom left image</span>
        <span class="ident">bottom_left_image</span>: { ... },

        <span class="comment">//  Omitted: Create the bottom right image</span>
        <span class="ident">bottom_right_image</span>: { ... },

        <span class="comment">//  Omitted: Load the bitmaps</span>
        <span class="ident">bitmaps</span>: [ ... ],
    };
    <span class="comment">//  Return the watch face</span>
    <span class="prelude-val">Ok</span>(<span class="ident">watch_face</span>)
}</pre></div>
<p>Signing off with <em>&quot;Ok boomer&quot;</em></p>
<p>Top left image...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">top_left_image</span>: {
    <span class="comment">//  Create the top left image</span>
    <span class="comment">//  `?` will terminate the function in case of error</span>
    <span class="kw">let</span> <span class="ident">image</span> <span class="op">=</span> <span class="ident">img</span>::<span class="ident">create</span>(<span class="ident">screen</span>, <span class="ident">ptr</span>::<span class="ident">null</span>()) <span class="question-mark">?</span> ; 

    <span class="comment">//  Set image position to top left</span>
    <span class="ident">obj</span>::<span class="ident">set_pos</span>(<span class="ident">image</span>, <span class="number">40</span>, <span class="number">20</span>) <span class="question-mark">?</span> ;  

    <span class="comment">//  Return the image as top_left_image</span>
    <span class="ident">image</span>                            
},</pre></div>
<p>Create top right, bottom left and bottom right images...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="comment">//  Create the top right image</span>
<span class="ident">top_right_image</span>: {
    <span class="kw">let</span> <span class="ident">image</span> <span class="op">=</span> <span class="ident">img</span>::<span class="ident">create</span>(<span class="ident">screen</span>, <span class="ident">ptr</span>::<span class="ident">null</span>()) <span class="question-mark">?</span> ;
    <span class="ident">obj</span>::<span class="ident">set_pos</span>(<span class="ident">image</span>, <span class="number">120</span>, <span class="number">20</span>) <span class="question-mark">?</span> ;  <span class="comment">//  Set image position to top right</span>
    <span class="ident">image</span>                             <span class="comment">//  Return the image as top_right_image</span>
},

<span class="comment">//  Create the bottom left image</span>
<span class="ident">bottom_left_image</span>: {
    <span class="kw">let</span> <span class="ident">image</span> <span class="op">=</span> <span class="ident">img</span>::<span class="ident">create</span>(<span class="ident">screen</span>, <span class="ident">ptr</span>::<span class="ident">null</span>()) <span class="question-mark">?</span> ;
    <span class="ident">obj</span>::<span class="ident">set_pos</span>(<span class="ident">image</span>, <span class="number">40</span>, <span class="number">120</span>) <span class="question-mark">?</span> ;  <span class="comment">//  Set image position to bottom left</span>
    <span class="ident">image</span>                             <span class="comment">//  Return the image as bottom_left_image</span>
},

<span class="comment">//  Create the bottom right image</span>
<span class="ident">bottom_right_image</span>: {
    <span class="kw">let</span> <span class="ident">image</span> <span class="op">=</span> <span class="ident">img</span>::<span class="ident">create</span>(<span class="ident">screen</span>, <span class="ident">ptr</span>::<span class="ident">null</span>()) <span class="question-mark">?</span> ;
    <span class="ident">obj</span>::<span class="ident">set_pos</span>(<span class="ident">image</span>, <span class="number">120</span>, <span class="number">120</span>) <span class="question-mark">?</span> ;  <span class="comment">//  Set image position to bottom right</span>
    <span class="ident">image</span>                              <span class="comment">//  Return the image as bottom_right_image</span>
},</pre></div>
<p>Load the bitmaps...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="comment">//  Load the bitmaps</span>
<span class="ident">bitmaps</span>: [
    <span class="ident">img</span>::<span class="ident">lv_img_dsc_t</span> { <span class="ident">data</span>: <span class="macro">include_bytes</span><span class="macro">!</span>(<span class="string">&quot;../bitmaps/0.bin&quot;</span>) <span class="kw">as</span> <span class="kw-2">*</span><span class="kw">const</span> <span class="ident">u8</span>, <span class="ident">header</span>, <span class="ident">data_size</span> },
    <span class="ident">img</span>::<span class="ident">lv_img_dsc_t</span> { <span class="ident">data</span>: <span class="macro">include_bytes</span><span class="macro">!</span>(<span class="string">&quot;../bitmaps/1.bin&quot;</span>) <span class="kw">as</span> <span class="kw-2">*</span><span class="kw">const</span> <span class="ident">u8</span>, <span class="ident">header</span>, <span class="ident">data_size</span> },
    <span class="ident">img</span>::<span class="ident">lv_img_dsc_t</span> { <span class="ident">data</span>: <span class="macro">include_bytes</span><span class="macro">!</span>(<span class="string">&quot;../bitmaps/2.bin&quot;</span>) <span class="kw">as</span> <span class="kw-2">*</span><span class="kw">const</span> <span class="ident">u8</span>, <span class="ident">header</span>, <span class="ident">data_size</span> },
    <span class="comment">//  Omitted: Bitmaps 3 to 8</span>
    <span class="ident">img</span>::<span class="ident">lv_img_dsc_t</span> { <span class="ident">data</span>: <span class="macro">include_bytes</span><span class="macro">!</span>(<span class="string">&quot;../bitmaps/9.bin&quot;</span>) <span class="kw">as</span> <span class="kw-2">*</span><span class="kw">const</span> <span class="ident">u8</span>, <span class="ident">header</span>, <span class="ident">data_size</span> },
]</pre></div>
<h1 id="webassembly-rust" class="section-header"><a href="#webassembly-rust">2 WebAssembly Rust</a></h1>
<p>TODO</p>
<h1 id="embedded-rust" class="section-header"><a href="#embedded-rust">3 Embedded Rust</a></h1>
<p>TODO</p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">4 What's Next</a></h1>
<p>TODO</p>
<p>Lemme know if you're keen to help! :-)</p>
<p>In the meantime, please go right ahead to create your own Watch Faces and publish them on crates.io... So that all PineTime Owners can share, learn and enjoy :-)</p>
<p><a href="https://lupyuen.github.io">Check out my PineTime articles</a></p>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here...</em></p>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/rust/app/src/handdrawn.md"><code>github.com/lupyuen/pinetime-rust-mynewt/rust/app/src/handdrawn.md</code></a></p>

    
</body>
</html>